{% extends "comments/_base.html" %}

{% block title %}Комментарии{% endblock %}

{% block header %}
    Комментарии
{% endblock %}

{% block content %}
    <form id="comment-form" method="post" enctype="multipart/form-data" action="{% url 'add_comment' %}" class="mb-4">
        {% csrf_token %}

        <!-- Toolbar for HTML tags -->
        <div class="toolbar">
            <button type="button" class="btn btn-outline-secondary" data-tag="<i></i>" onclick="addTag(this.getAttribute('data-tag'))">[i]</button>
            <button type="button" class="btn btn-outline-secondary" data-tag="<strong></strong>" onclick="addTag(this.getAttribute('data-tag'))">[strong]</button>
            <button type="button" class="btn btn-outline-secondary" data-tag="<code></code>" onclick="addTag(this.getAttribute('data-tag'))">[code]</button>
            <button type="button" class="btn btn-outline-secondary" data-tag="<a href=''></a>" onclick="addTag(this.getAttribute('data-tag'))">[a]</button>
        </div>

        {{ form.as_p }}
        <button type="button" class="btn btn-secondary" id="preview-button">Предварительный просмотр</button>
        <button type="submit" class="btn btn-success">Добавить комментарий</button>
    </form>
    <hr>
    <h2>Список комментариев</h2>
    <div id="preview-section" class="mb-4"></div> <!-- Section for preview -->

    <!-- Comments table -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th class="sortable" data-sort-by="username" data-current-order="{{ request.GET.order|default:'desc' }}" onclick="sortTable(this)">User Name</th>
                <th class="sortable" data-sort-by="email" data-current-order="{{ request.GET.order|default:'desc' }}" onclick="sortTable(this)">E-mail</th>
                <th class="sortable" data-sort-by="created_at" data-current-order="{{ request.GET.order|default:'desc' }}" onclick="sortTable(this)">Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for comment in comments %}
                <tr>
                    <td>{{ comment.username|escape }}</td>
                    <td>{{ comment.email|escape }}</td>
                    <td>{{ comment.created_at }}</td>
                    <td>
                        <!-- Button to toggle reply form -->
                        <button type="button" enctype="multipart/form-data" class="btn btn-primary" onclick="toggleReplyForm('{{ comment.id }}')">Ответить</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Recursive display of comments -->
    <div id="comments">
        {% for comment in comments %}
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">{{ comment.username|escape }}</h5>
                    <h6 class="card-subtitle mb-2 text-muted">{{ comment.email|escape }}</h6>
                    <p class="card-text">{{ comment.text|safe }}</p>

                    {% if comment.image %}
                        <img src="{{ comment.image.url }}" alt="Comment image" class="img-fluid mb-3" style="max-width: 100%; max-height: 240px;"/>
                    {% endif %}

                    <footer class="blockquote-footer"><cite title="Source Title">{{ comment.created_at }}</cite></footer>

                    <!-- Button to show reply form -->
                    <button type="button" class="btn btn-primary" onclick="toggleReplyForm('{{ comment.id }}')">Ответить</button>

                    <!-- Reply form -->
                    <div id="reply-form-{{ comment.id }}" class="reply-form mt-3">
                        <form method="post" enctype="multipart/form-data" action="{% url 'add_reply' comment.id %}">
                        {% csrf_token %}
                        {{ form.as_p }}
                        <button type="submit" class="btn btn-primary">Отправить</button>
                    </form>
                    </div>

                    <!-- Recursive display of replies -->
                    <div class="mt-3">
                        {% include 'comments/replies.html' with replies=comment.replies.all %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if comments.has_previous %}
                <li class="page-item"><a class="page-link" href="?page=1&sort_by={{ request.GET.sort_by }}&order={{ request.GET.order }}">Первая</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ comments.previous_page_number }}&sort_by={{ request.GET.sort_by }}&order={{ request.GET.order }}">Предыдущая</a></li>
            {% endif %}

            <li class="page-item disabled"><span class="page-link">Страница {{ comments.number }} из {{ comments.paginator.num_pages }}</span></li>

            {% if comments.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ comments.next_page_number }}&sort_by={{ request.GET.sort_by }}&order={{ request.GET.order }}">Следующая</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ comments.paginator.num_pages }}&sort_by={{ request.GET.sort_by }}&order={{ request.GET.order }}">Последняя</a></li>
            {% endif %}
        </ul>
    </nav>
{% endblock %}
